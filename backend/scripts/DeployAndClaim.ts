import { ethers, web3 } from "hardhat";

// --- CONFIGURATION ---
const EXISTING_PROOF_HEX =
    "0x0000000000000000000000000000000000000000000000000000000000000020576562324a736f6e0000000000000000000000000000000000000000000000005075626c696357656232000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000130033000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004868747470733a2f2f7374656c6c696665726f75732d66616972792d6e6f6e73796e746163746963616c6c792e6e67726f6b2d667265652e6465762f7374617475732f4246313233340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003474554000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000437b226e67726f6b2d736b69702d62726f777365722d7761726e696e67223a2274727565222c22557365722d4167656e74223a22466c6172652d4644432d54657374227d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027b7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027b7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000427b666c696768743a202e666c6967687449642c207374617475733a202e7374617475732c2064656c61794d696e757465733a202e64656c61795f6d696e757465737d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f57b22636f6d706f6e656e7473223a205b7b22696e7465726e616c54797065223a2022737472696e67222c20226e616d65223a2022666c69676874222c202274797065223a2022737472696e67227d2c7b22696e7465726e616c54797065223a2022737472696e67222c20226e616d65223a2022737461747573222c202274797065223a2022737472696e67227d2c7b22696e7465726e616c54797065223a202275696e74323536222c20226e616d65223a202264656c61794d696e75746573222c202274797065223a202275696e74323536227d5d2c226e616d65223a20227461736b222c2274797065223a20227475706c65227d0000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000d200000000000000000000000000000000000000000000000000000000000000064246313233340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000744656c6179656400000000000000000000000000000000000000000000000000";

const MERKLE_PROOF = [
    "0x4266e5ed962b6ce485671a9785ab7fcb8f7b46dd164212d73eb1ead6fd9eafd8",
    "0xe81f29031ebf36324242e4cddb92d7358ca44bf8ee6e389f3308f1212a1eede1",
    "0xc951386acc7ce3b119e683315c7e710a7d04d34aa7e37067326100c8b3386891",
];

async function main() {
    const [deployer] = await ethers.getSigners();
    console.log("üöÄ STARTING FINAL CLAIM TEST");

    // 1. USE WEB3 (ARTIFACTS) TO DEPLOY
    // This is the magic fix: using 'artifacts.require' instead of 'ethers.getContractFactory'
    const FlightSurety = artifacts.require("FlightSurety");

    // Note: 'new' is the Truffle way to deploy
    const insurance = await FlightSurety.new(deployer.address);
    console.log(`   ‚úÖ FlightSurety Deployed: ${insurance.address}`);

    // 2. FUND (Using Ethers is fine here, it's just a simple transfer)
    console.log("   üí∞ Funding pool with 1.0 C2FLR...");
    const fundTx = await deployer.sendTransaction({
        to: insurance.address,
        value: ethers.parseUnits("1.0", "ether"),
    });
    await fundTx.wait();

    // 3. DECODE & CLAIM
    console.log("   1Ô∏è‚É£  Decoding proof...");
    const IWeb2JsonVerification = await artifacts.require("IWeb2JsonVerification");
    const responseType = IWeb2JsonVerification._json.abi[0].inputs[0].components[1];

    // Web3's decoder is robust
    const decodedDataStruct = web3.eth.abi.decodeParameter(responseType, EXISTING_PROOF_HEX);

    console.log("   2Ô∏è‚É£  Calling claimPayout...");

    // üö® KEY DIFFERENCE:
    // Truffle contract calls don't return a 'tx' object you have to wait for.
    // They wait automatically and return the Receipt.
    const result = await insurance.claimPayout({
        merkleProof: MERKLE_PROOF,
        data: decodedDataStruct,
    });

    console.log("   üéâ SUCCESS! Payout claimed.");
    console.log(`   Tx Hash: ${result.tx}`);
    console.log("   (Check the Coston2 Explorer to see your 0.01 C2FLR arrived!)");
}

main().catch(console.error);
