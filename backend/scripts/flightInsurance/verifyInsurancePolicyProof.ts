import { artifacts, ethers, web3 } from "hardhat";
import { getFXRPTokenAddress } from "../utils/fassets";

// --- CONFIGURATION ---
const EXISTING_PROOF_HEX =
    "0x0000000000000000000000000000000000000000000000000000000000000020576562324a736f6e0000000000000000000000000000000000000000000000005075626c696357656232000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000130033000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004868747470733a2f2f7374656c6c696665726f75732d66616972792d6e6f6e73796e746163746963616c6c792e6e67726f6b2d667265652e6465762f7374617475732f4246313233340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003474554000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000437b226e67726f6b2d736b69702d62726f777365722d7761726e696e67223a2274727565222c22557365722d4167656e74223a22466c6172652d4644432d54657374227d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027b7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027b7d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000427b666c696768743a202e666c6967687449642c207374617475733a202e7374617475732c2064656c61794d696e757465733a202e64656c61795f6d696e757465737d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f57b22636f6d706f6e656e7473223a205b7b22696e7465726e616c54797065223a2022737472696e67222c20226e616d65223a2022666c69676874222c202274797065223a2022737472696e67227d2c7b22696e7465726e616c54797065223a2022737472696e67222c20226e616d65223a2022737461747573222c202274797065223a2022737472696e67227d2c7b22696e7465726e616c54797065223a202275696e74323536222c20226e616d65223a202264656c61794d696e75746573222c202274797065223a202275696e74323536227d5d2c226e616d65223a20227461736b222c2274797065223a20227475706c65227d0000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000d200000000000000000000000000000000000000000000000000000000000000064246313233340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000744656c6179656400000000000000000000000000000000000000000000000000";

const MERKLE_PROOF = [
    "0x4266e5ed962b6ce485671a9785ab7fcb8f7b46dd164212d73eb1ead6fd9eafd8",
    "0xe81f29031ebf36324242e4cddb92d7358ca44bf8ee6e389f3308f1212a1eede1",
    "0xc951386acc7ce3b119e683315c7e710a7d04d34aa7e37067326100c8b3386891",
];

const fxrp = (value: string) => ethers.parseUnits(value, 6);

async function main() {
    const [deployer] = await ethers.getSigners();
    console.log("Deployer:", deployer.address);

    const tokenAddr = await getFXRPTokenAddress();
    const token = await ethers.getContractAt("IERC20", tokenAddr);
    console.log("FXRP:", tokenAddr);

    const InsurancePool = await ethers.getContractFactory("InsurancePool");
    const pool = await InsurancePool.deploy(tokenAddr);
    await pool.waitForDeployment();
    const poolAddr = await pool.getAddress();
    console.log("InsurancePool:", poolAddr);

    const InsurancePolicy = await ethers.getContractFactory("InsurancePolicy");
    const policy = await InsurancePolicy.deploy(tokenAddr, poolAddr, ethers.ZeroAddress);
    await policy.waitForDeployment();
    const policyAddr = await policy.getAddress();
    console.log("InsurancePolicy:", policyAddr);

    await (await pool.setPolicyContract(policyAddr)).wait();

    const premium = fxrp("0.0001");
    const coverage = fxrp("0.002");
    const depositAmount = fxrp("0.01");

    const balance = await token.balanceOf(deployer.address);
    if (balance < depositAmount + premium) {
        throw new Error(`Insufficient FXRP balance: ${balance.toString()}`);
    }

    await (await token.approve(poolAddr, depositAmount)).wait();
    await (await pool.deposit(depositAmount)).wait();

    console.log("soosososo");
    await (await token.transfer(policyAddr, premium, {gasLimit: 10000000})).wait();
    console.log("siisisiisisi");
    await (await policy.createPolicy("BF1234", premium, coverage, premium, {gasLimit: 10000000})).wait();
    console.log("sasasasaasa");

    const IWeb2JsonVerification = await artifacts.require("IWeb2JsonVerification");
    const responseType = IWeb2JsonVerification._json.abi[0].inputs[0].components[1];
    const decodedDataStruct = web3.eth.abi.decodeParameter(responseType, EXISTING_PROOF_HEX);

    console.log("seseseseses");

    const beforeResolveBalance = await token.balanceOf(deployer.address);
    const result = await policy.resolvePolicy(0, {
        merkleProof: MERKLE_PROOF,
        data: decodedDataStruct,
    }, {gasLimit: 10000000});
    await result.wait();
    const afterResolveBalance = await token.balanceOf(deployer.address);

    const payout = afterResolveBalance - beforeResolveBalance;
    if (payout < coverage) {
        throw new Error(`Payout check failed: received ${payout.toString()} < ${coverage.toString()}`);
    }
    const locked = await pool.lockedCoverage(0);
    if (locked !== 0n) {
        throw new Error(`Coverage still locked: ${locked.toString()}`);
    }

    console.log("âœ… Proof verified and policy resolved. Payout received.");
}

main().catch((err) => {
    console.error(err);
    process.exitCode = 1;
});
